<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1">测试请求</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/guide/http/testing.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    <p>对于任何外部依赖，你都必须模拟 HTTP 后端，以便你的测试可以模拟与远程服务器的交互。<code>@angular/common/http/testing</code> 库提供了一些工具，可以捕获应用发出的请求，对它们进行断言，并模拟响应以模拟后端的行为。</p>
<p>这个测试库是为这样一种模式设计的：应用先执行代码并发出请求。然后，测试会期望某些请求已经被发出或尚未发出，针对这些请求执行断言，并最终通过“刷新”每个预期的请求来提供响应。</p>
<p>最后，测试可以验证应用没有发出任何意外的请求。</p>

  <h2 id="setup-for-testing">
    <a href="#setup-for-testing" class="docs-anchor" tabindex="-1" aria-label="Link to Setup for testing">测试的建立</a>
  </h2>
  <p>要开始测试 <a href="/api/common/http/HttpClient"><code>HttpClient</code></a> 的用法，请配置 <a href="/api/core/testing/TestBed"><code>TestBed</code></a> 并将 <a href="/api/common/http/provideHttpClient"><code>provideHttpClient()</code></a> 和 <a href="/api/common/http/testing/provideHttpClientTesting"><code>provideHttpClientTesting()</code></a> 包含在您的测试设置中。这将配置 <a href="/api/common/http/HttpClient"><code>HttpClient</code></a> 以使用测试后端而不是真实网络。它还提供 <a href="/api/common/http/testing/HttpTestingController"><code>HttpTestingController</code></a>，您将使用它与测试后端进行交互，设置关于已发出哪些请求的期望，并刷新对这些请求的响应。配置后，<a href="/api/common/http/testing/HttpTestingController"><code>HttpTestingController</code></a> 可以从 <a href="/api/core/testing/TestBed"><code>TestBed</code></a> 注入。</p>
<p>请注意，要在 <a href="/api/common/http/testing/provideHttpClientTesting"><code>provideHttpClientTesting()</code></a> <strong>之前</strong> 提供 <a href="/api/common/http/provideHttpClient"><code>provideHttpClient()</code></a>，因为 <a href="/api/common/http/testing/provideHttpClientTesting"><code>provideHttpClientTesting()</code></a> 会覆盖 <a href="/api/common/http/provideHttpClient"><code>provideHttpClient()</code></a> 的部分内容。反之则可能破坏您的测试。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"><a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">configureTestingModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  providers: [</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // ... other test providers</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/provideHttpClient">provideHttpClient</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/testing/provideHttpClientTesting">provideHttpClientTesting</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  ],</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> httpTesting</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/common/http/testing/HttpTestingController">HttpTestingController</a>);</span></span></code></pre>
  </div><p>现在，当你的测试发出请求时，它们将访问测试后端而不是正常的后端。你可以使用 <code>httpTesting</code> 对这些请求进行断言。</p>

  <h2 id="expecting-and-answering-requests">
    <a href="#expecting-and-answering-requests" class="docs-anchor" tabindex="-1" aria-label="Link to Expecting and answering requests">期望和响应请求</a>
  </h2>
  <p>例如，你可以编写一个测试，该测试期望发生 GET 请求并提供模拟响应：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"><a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">configureTestingModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  providers: [</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ConfigService,</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/provideHttpClient">provideHttpClient</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/testing/provideHttpClientTesting">provideHttpClientTesting</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  ],</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> httpTesting</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/common/http/testing/HttpTestingController">HttpTestingController</a>);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Load `ConfigService` and request the current configuration.</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> service</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ConfigService);</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> config$</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.configService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;();</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// `firstValueFrom` subscribes to the `Observable`, which makes the HTTP request,</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// and creates a `Promise` of the response.</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> configPromise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> firstValueFrom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(config$);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// At this point, the request is pending, and we can assert it was made</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// via the `HttpTestingController`:</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expectOne</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'/api/config'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Request to load the configuration'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// We can assert various properties of the request if desired.</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(req.request.method).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'GET'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Flushing the request causes it to complete, delivering the result.</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/testing/flush">flush</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">DEFAULT_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// We can then assert that the response was successfully delivered by the `ConfigService`:</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> configPromise).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toEqual</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">DEFAULT_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Finally, we can assert that no other requests were made.</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span></code></pre>
  </div>
    <div class="docs-alert docs-alert-note">
    <p><strong>注意：</strong> 如果测试发出了多个符合给定标准的请求，<code>expectOne</code> 将会失败。</p>

    </div>
    <p>作为对 <code>req.method</code> 进行断言的替代方法，你可以使用 <code>expectOne</code> 的扩展形式来同时匹配请求方法：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expectOne</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'GET'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  url: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'/api/config'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Request to load the configuration'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre>
  </div>
    <div class="docs-alert docs-alert-helpful">
    <p><strong>提示：</strong> 期望 API 针对请求的完整 URL 进行匹配，包括任何查询参数。</p>

    </div>
    <p>最后一步，验证没有剩余的未完成请求，这很常见，你可以将其移至 <code>afterEach()</code> 步骤中：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">afterEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Verify that none of the tests make any extra HTTP requests.</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  <a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/common/http/testing/HttpTestingController">HttpTestingController</a>).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
  </div>
  <h2 id="handling-more-than-one-request-at-once">
    <a href="#handling-more-than-one-request-at-once" class="docs-anchor" tabindex="-1" aria-label="Link to Handling more than one request at once">一次处理多个请求</a>
  </h2>
  <p>如果需要在测试中响应重复的请求，请使用 <code>match()</code> API 而不是 <code>expectOne()</code>。它接受相同的参数，但返回匹配请求的数组。一旦返回，这些请求将从未来的匹配中移除，你需要负责刷新和验证它们。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> allGetRequests</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'GET'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> allGetRequests) {</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Handle responding to each request.</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div>
  <h2 id="advanced-matching">
    <a href="#advanced-matching" class="docs-anchor" tabindex="-1" aria-label="Link to Advanced matching">高级匹配</a>
  </h2>
  <p>所有匹配函数都接受一个谓词函数用于自定义匹配逻辑：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Look for one request that has a request body.</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> requestsWithBody</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expectOne</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> req.body </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre>
  </div><p><code>expectNone</code> 函数断言没有请求与给定的条件匹配。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Assert that no mutation requests have been issued.</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expectNone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> req.method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'GET'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre>
  </div>
  <h2 id="testing-error-handling">
    <a href="#testing-error-handling" class="docs-anchor" tabindex="-1" aria-label="Link to Testing error handling">测试错误处理</a>
  </h2>
  <p>你应该在 HTTP 请求失败时测试应用的响应。</p>

  <h3 id="backend-errors">
    <a href="#backend-errors" class="docs-anchor" tabindex="-1" aria-label="Link to Backend errors">后端错误</a>
  </h3>
  <p>要测试后端错误的处理（当服务器返回非成功的状态代码时），请使用错误响应刷新请求，该错误响应模拟你的后端在请求失败时将返回的内容。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expectOne</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'/api/config'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/testing/flush">flush</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Failed!'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, {status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, statusText: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Internal Server Error'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Assert that the application successfully handled the backend error.</span></span></code></pre>
  </div>
  <h3 id="network-errors">
    <a href="#network-errors" class="docs-anchor" tabindex="-1" aria-label="Link to Network errors">网络错误</a>
  </h3>
  <p>请求也可能由于网络错误而失败，这些错误会以 <code>ProgressEvent</code> 错误的形式出现。这些错误可以使用 <code>error()</code> 方法传递：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expectOne</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'/api/config'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ProgressEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'network error!'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Assert that the application successfully handled the network error.</span></span></code></pre>
  </div>
  <h2 id="testing-an-interceptor">
    <a href="#testing-an-interceptor" class="docs-anchor" tabindex="-1" aria-label="Link to Testing an Interceptor">测试拦截器</a>
  </h2>
  <p>你应该测试你的拦截器在期望的情况下是否工作正常。</p>
<p>例如，可能需要应用将服务生成的身份验证令牌添加到每个传出的请求。
可以使用拦截器来强制执行此行为：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> authInterceptor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/common/http/HttpRequest">HttpRequest</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/common/http/HttpHandlerFn">HttpHandlerFn</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Observable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/common/http/HttpEvent">HttpEvent</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;&gt; {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> authService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(AuthService);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> clonedRequest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">clone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    headers: request.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'X-Authentication-Token'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, authService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getAuthToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()),</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  });</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(clonedRequest);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>此拦截器的 <a href="/api/core/testing/TestBed"><code>TestBed</code></a> 配置应依赖于 <a href="/api/common/http/withInterceptors"><code>withInterceptors</code></a> 特性。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"><a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">configureTestingModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  providers: [</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    AuthService,</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Testing one interceptor at a time is recommended.</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/provideHttpClient">provideHttpClient</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/common/http/withInterceptors">withInterceptors</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">([authInterceptor])),</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/testing/provideHttpClientTesting">provideHttpClientTesting</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  ],</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
  </div><p> <a href="/api/common/http/testing/HttpTestingController"><code>HttpTestingController</code></a> 可以检索请求实例，然后对其进行检查以确保请求已被修改。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> service</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(AuthService);</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> httpTesting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expectOne</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'/api/config'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(req.request.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'X-Authentication-Token'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toEqual</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(service.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getAuthToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span></code></pre>
  </div><p>可以使用基于类的拦截器来实现类似的拦截器：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/Injectable">Injectable</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AuthInterceptor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/common/http/HttpInterceptor">HttpInterceptor</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> authService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(AuthService);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  intercept</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/common/http/HttpRequest">HttpRequest</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/common/http/HttpHandler">HttpHandler</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Observable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/common/http/HttpEvent">HttpEvent</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;&gt; {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> clonedRequest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">clone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      headers: request.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'X-Authentication-Token'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.authService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getAuthToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()),</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> next.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(clonedRequest);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>为了测试它，<a href="/api/core/testing/TestBed"><code>TestBed</code></a> 配置应该改为：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"><a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">configureTestingModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  providers: [</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    AuthService,</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/provideHttpClient">provideHttpClient</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/common/http/withInterceptorsFromDi">withInterceptorsFromDi</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()),</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    <a href="/api/common/http/testing/provideHttpClientTesting">provideHttpClientTesting</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // We rely on the HTTP_INTERCEPTORS token to register the AuthInterceptor as an HttpInterceptor</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    { provide: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"><a href="/api/common/http/HTTP_INTERCEPTORS">HTTP_INTERCEPTORS</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, useClass: AuthInterceptor, multi: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> },</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  ],</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
  </div>