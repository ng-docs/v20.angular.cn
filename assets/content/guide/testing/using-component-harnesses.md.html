<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1">在测试中使用组件测试工具</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/guide/testing/using-component-harnesses.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    
  <h2 id="before-you-start">
    <a href="#before-you-start" class="docs-anchor" tabindex="-1" aria-label="Link to Before you start">开始之前</a>
  </h2>
  
    <div class="docs-alert docs-alert-tip">
    <p><strong>提示：</strong> 本指南假定你已阅读过<a href="guide/testing/component-harnesses-overview">组件测试工具概览指南</a>。如果你是组件测试工具的新手，请先阅读该指南。</p>

    </div>
    
  <h3 id="cdk-installation">
    <a href="#cdk-installation" class="docs-anchor" tabindex="-1" aria-label="Link to CDK Installation">CDK 安装</a>
  </h3>
  <p>该<a href="https://material.angular.dev/cdk/categories" target="_blank">组件开发工具包 (CDK)</a>是一组用于构建组件的行为基元。要使用组件测试工具，请先从 npm 安装 <code>@angular/cdk</code>。您可以使用 Angular CLI 从终端执行此操作：</p>
<div class="docs-code shell">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ng</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> @angular/cdk</span></span></code></pre>
  </div>
  <h2 id="test-harness-environments-and-loaders">
    <a href="#test-harness-environments-and-loaders" class="docs-anchor" tabindex="-1" aria-label="Link to Test harness environments and loaders">测试工具环境和加载器</a>
  </h2>
  <p>你可以在不同的测试环境中使用组件测试工具。Angular CDK 支持两种内置环境：</p>

  <ul class="docs-list">
    <li>使用 Angular 的 <a href="/api/core/testing/TestBed"><code>TestBed</code></a> 进行单元测试</li>
<li>使用 <a href="https://developer.mozilla.org/en-US/docs/Web/WebDriver" target="_blank">WebDriver</a> 的端到端测试</li>

  </ul>
  <p>每个环境都提供一个 <strong>测试工具加载器</strong>。加载器会创建你在整个测试中使用的测试工具实例。有关受支持的测试环境的更具体指导，请参见下文。</p>
<p>其他测试环境需要自定义绑定。有关更多信息，请参阅<a href="guide/testing/component-harnesses-testing-environments">为其他测试环境添加测试工具支持指南</a>。</p>

  <h3 id="using-the-loader-from-testbedharnessenvironment-for-unit-tests">
    <a href="#using-the-loader-from-testbedharnessenvironment-for-unit-tests" class="docs-anchor" tabindex="-1" aria-label="Link to Using the loader from <code>TestbedHarnessEnvironment</code> for unit tests">在单元测试中使用来自 <code>TestbedHarnessEnvironment</code> 的加载器</a>
  </h3>
  <p>对于单元测试，您可以从 <a href="/api/cdk/testing/TestbedHarnessEnvironment">TestbedHarnessEnvironment</a> 创建测试工具加载器。此环境使用 Angular 的 <a href="/api/core/testing/TestBed"><code>TestBed</code></a> 创建的<a href="api/core/testing/ComponentFixture">组件夹具</a>。</p>
<p>要创建以 fixture 的根元素为根的测试工具加载器，请使用 <code>loader()</code> 方法：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> fixture</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/createComponent">createComponent</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyComponent);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Create a harness loader from the fixture</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> loader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/cdk/testing/testbed/TestbedHarnessEnvironment">TestbedHarnessEnvironment</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">loader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(fixture);</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Use the loader to get harness instances</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> myComponentHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyComponent);</span></span></code></pre>
  </div><p>要为 fixture 之外的元素创建测试工具加载器，请使用 <code>documentRootLoader()</code> 方法。例如，显示浮动元素或弹出窗口的代码通常会将 DOM 元素直接附着到文档主体，例如 Angular CDK 中的 <code>Overlay</code> 服务。</p>
<p>你还可以直接使用 <code>harnessForFixture()</code> 为 fixture 根元素处的测试工具直接创建一个测试工具加载器。</p>

  <h3 id="using-the-loader-from-seleniumwebdriverharnessenvironment-for-end-to-end-tests">
    <a href="#using-the-loader-from-seleniumwebdriverharnessenvironment-for-end-to-end-tests" class="docs-anchor" tabindex="-1" aria-label="Link to Using the loader from <code>SeleniumWebDriverHarnessEnvironment</code> for end-to-end tests">在端到端测试中使用来自 <code>SeleniumWebDriverHarnessEnvironment</code> 的加载器</a>
  </h3>
  <p>对于基于 WebDriver 的端到端测试，您可以使用 <a href="/api/cdk/testing/selenium-webdriver/SeleniumWebDriverHarnessEnvironment"><code>SeleniumWebDriverHarnessEnvironment</code></a> 创建测试工具加载器。</p>
<p>使用 <code>loader()</code> 方法获取当前 HTML 文档的测试工具加载器实例，该实例以文档的根元素为根。此环境使用 WebDriver 客户端。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> wd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> webdriver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">WebDriver</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getMyWebDriverClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> loader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/cdk/testing/selenium-webdriver/SeleniumWebDriverHarnessEnvironment">SeleniumWebDriverHarnessEnvironment</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">loader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(wd);</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> myComponentHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyComponent);</span></span></code></pre>
  </div>
  <h2 id="using-a-harness-loader">
    <a href="#using-a-harness-loader" class="docs-anchor" tabindex="-1" aria-label="Link to Using a harness loader">使用测试工具加载器</a>
  </h2>
  <p>测试工具加载器实例对应于特定的 DOM 元素，并用于为该特定元素下的元素创建组件测试工具实例。</p>
<p>要获取元素的第一个实例的 <a href="/api/cdk/testing/ComponentHarness"><code>ComponentHarness</code></a>，请使用 <code>getHarness()</code> 方法。要获取所有 <a href="/api/cdk/testing/ComponentHarness"><code>ComponentHarness</code></a> 实例，请使用 <code>getAllHarnesses()</code> 方法。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Get harness for first instance of the element</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> myComponentHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyComponent);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Get harnesses for all instances of the element</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> myComponentHarnesses</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarnesses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyComponent);</span></span></code></pre>
  </div><p>除了 <code>getHarness</code> 和 <code>getAllHarnesses</code> 之外，<a href="/api/cdk/testing/HarnessLoader"><code>HarnessLoader</code></a> 还有其他几种有用的查询测试工具的方法：</p>

  <ul class="docs-list">
    <li><code>getHarnessAtIndex(...)</code>：获取在特定索引处与给定条件匹配的组件的测试工具。</li>
<li><code>countHarnesses(...)</code>：计算与给定条件匹配的组件实例的数量。</li>
<li><code>hasHarness(...)</code>：检查是否至少有一个组件实例与给定条件匹配。</li>

  </ul>
  <p>例如，考虑一个可复用的对话框按钮组件，该组件在单击时打开一个对话框。它包含以下组件，每个组件都有一个对应的测试工具：</p>

  <ul class="docs-list">
    <li><code>MyDialogButton</code>（组合了 <code>MyButton</code> 和 <code>MyDialog</code>，并提供便捷的 API）</li>
<li><code>MyButton</code>（一个标准的按钮组件）</li>
<li><code>MyDialog</code>（一个通过 <code>MyDialogButton</code> 在点击时附着到 <code>document.body</code> 的对话框）</li>

  </ul>
  <p>以下测试为每个组件加载测试工具：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fixture</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/core/testing/ComponentFixture">ComponentFixture</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">MyDialogButton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;;</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/cdk/testing/HarnessLoader">HarnessLoader</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> rootLoader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/cdk/testing/HarnessLoader">HarnessLoader</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">beforeEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  fixture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/core/testing/TestBed">TestBed</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/createComponent">createComponent</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyDialogButton);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  loader </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/cdk/testing/testbed/TestbedHarnessEnvironment">TestbedHarnessEnvironment</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">loader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(fixture);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  rootLoader </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/cdk/testing/testbed/TestbedHarnessEnvironment">TestbedHarnessEnvironment</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">documentRootLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(fixture);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'loads harnesses'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Load a harness for the bootstrapped component with `harnessForFixture`</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  dialogButtonHarness </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> <a href="/api/cdk/testing/testbed/TestbedHarnessEnvironment">TestbedHarnessEnvironment</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">harnessForFixture</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(fixture, MyDialogButtonHarness);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // The button element is inside the fixture's root element, so we use `loader`.</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> buttonHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyButtonHarness);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Click the button to open the dialog</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> buttonHarness.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">click</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // The dialog is appended to `document.body`, outside of the fixture's root element,</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // so we use `rootLoader` in this case.</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> dialogHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> rootLoader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyDialogHarness);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // ... make some assertions</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
  </div>
  <h3 id="harness-behavior-in-different-environments">
    <a href="#harness-behavior-in-different-environments" class="docs-anchor" tabindex="-1" aria-label="Link to Harness behavior in different environments">不同环境中的测试工具行为</a>
  </h3>
  <p>测试工具在所有环境中的行为可能不完全相同。在真实用户交互与单元测试中生成的模拟事件之间，一些差异是不可避免的。Angular CDK 尽最大努力在可能的范围内规范化行为。</p>

  <h3 id="interacting-with-child-elements">
    <a href="#interacting-with-child-elements" class="docs-anchor" tabindex="-1" aria-label="Link to Interacting with child elements">与子元素交互</a>
  </h3>
  <p>要与此测试工具加载器的根元素下的元素进行交互，请使用子元素的 <a href="/api/cdk/testing/HarnessLoader"><code>HarnessLoader</code></a> 实例。对于子元素的第一个实例，请使用 <code>getChildLoader()</code> 方法。对于子元素的所有实例，请使用 <code>getAllChildLoaders()</code> 方法。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> myComponentHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyComponent);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Get loader for first instance of child element with '.child' selector</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> childLoader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> myComponentHarness.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'.child'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Get loaders for all instances of child elements with '.child' selector</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> allChildLoaders</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> myComponentHarness.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getAllChildLoaders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'.child'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre>
  </div>
  <h3 id="filtering-harnesses">
    <a href="#filtering-harnesses" class="docs-anchor" tabindex="-1" aria-label="Link to Filtering harnesses">过滤测试工具</a>
  </h3>
  <p>当页面包含特定组件的多个实例时，您可能希望根据组件的某个属性进行过滤以获取特定的组件实例。为此，您可以使用<strong>测试工具谓词</strong>，这是一个用于将 <a href="/api/cdk/testing/ComponentHarness"><code>ComponentHarness</code></a> 类与可用于过滤组件实例的谓词函数关联起来的类。</p>
<p>当您向 <a href="/api/cdk/testing/HarnessLoader"><code>HarnessLoader</code></a> 请求测试工具时，您实际上是在提供一个 HarnessQuery。查询可以是以下两者之一：</p>

  <ul class="docs-list">
    <li>测试工具构造函数。这只会获取该测试工具</li>
<li>一个 <a href="/api/cdk/testing/HarnessPredicate"><code>HarnessPredicate</code></a>，它获取基于一个或多个条件过滤的 harnesses</li>

  </ul>
  <p><a href="/api/cdk/testing/HarnessPredicate"><code>HarnessPredicate</code></a> 支持一些基础过滤器（选择器、祖先选择器），这些过滤器适用于任何扩展了 <a href="/api/cdk/testing/ComponentHarness"><code>ComponentHarness</code></a> 的类。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Example of loading a MyButtonComponentHarness with a harness predicate</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> disabledButtonPredicate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/cdk/testing/HarnessPredicate">HarnessPredicate</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyButtonComponentHarness, {selector: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'[disabled]'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> disabledButton</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(disabledButtonPredicate);</span></span></code></pre>
  </div><p>然而，harnesses 通常会实现一个静态的 <code>with()</code> 方法，该方法接受特定于组件的过滤选项并返回一个 <a href="/api/cdk/testing/HarnessPredicate"><code>HarnessPredicate</code></a>。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Example of loading a MyButtonComponentHarness with a specific selector</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> button</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyButtonComponentHarness.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({selector: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'btn'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}))</span></span></code></pre>
  </div><p>有关更多详细信息，请参阅特定的测试工具文档，因为其他过滤选项特定于每个测试工具的实现。</p>

  <h2 id="using-test-harness-apis">
    <a href="#using-test-harness-apis" class="docs-anchor" tabindex="-1" aria-label="Link to Using test harness APIs">使用测试工具 API</a>
  </h2>
  <p>虽然每个 harness 都定义了与其对应组件特定的 API，但它们都共享一个通用基类 <a href="/api/cdk/testing/ComponentHarness">ComponentHarness</a>。这个基类定义了一个静态属性 <code>hostSelector</code>，它将 harness 类与 DOM 中的组件实例进行匹配。</p>
<p>除此之外，任何给定测试工具的 API 都特定于其对应的组件；请参阅组件的文档以了解如何使用特定的测试工具。</p>
<p>例如，以下是使用 <a href="https://material.angular.dev/components/slider/api#MatSliderHarness" target="_blank">Angular Material 滑块组件 harness</a> 的组件的测试：</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'should get value of slider thumb'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> slider</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MatSliderHarness);</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> thumb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> slider.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getEndThumb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> thumb.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
  </div>
  <h2 id="interop-with-angular-change-detection">
    <a href="#interop-with-angular-change-detection" class="docs-anchor" tabindex="-1" aria-label="Link to Interop with Angular change detection">与 Angular 变更检测互操作</a>
  </h2>
  <p>默认情况下，测试工具在读取 DOM 元素的状态之前以及与 DOM 元素交互之后运行 Angular 的 <a href="https://angular.dev/best-practices/runtime-performance" target="_blank">变更检测</a>。</p>
<p>在测试中，有时您可能需要对变更检测进行更细粒度的控制。例如，在异步操作挂起时检查组件的状态。在这些情况下，请使用 <a href="/api/cdk/testing/manualChangeDetection"><code>manualChangeDetection</code></a> 函数来禁用代码块的自动变更检测处理。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'checks state while async action is in progress'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> buttonHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyButtonHarness);</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/cdk/testing/manualChangeDetection">manualChangeDetection</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> buttonHarness.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">click</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    fixture.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">detectChanges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Check expectations while async click operation is in progress.</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isProgressSpinnerVisible</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fixture.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">whenStable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Check expectations after async click operation complete.</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isProgressSpinnerVisible</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  });</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
  </div><p>几乎所有的测试工具方法都是异步的，并返回一个 <code>Promise</code> 以支持以下各项：</p>

  <ul class="docs-list">
    <li>支持单元测试</li>
<li>支持端到端测试</li>
<li>使测试免受异步行为更改的影响</li>

  </ul>
  <p>Angular 团队建议使用 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank">await</a> 以提升测试的可读性。调用 <code>await</code> 会阻塞你的测试的执行，直到相关的 <code>Promise</code> 求解。</p>
<p>偶尔，您可能希望同时执行多个操作，并等待它们全部完成，而不是按顺序执行每个操作。例如，读取单个组件的多个属性。在这些情况下，请使用 <a href="/api/cdk/testing/parallel"><code>parallel</code></a> 函数来并行化操作。parallel 函数的工作方式类似于 <code>Promise.all</code>，同时还优化了变更检测检查。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'reads properties in parallel'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> checkboxHarness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> loader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getHarness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MyCheckboxHarness);</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Read the checked and intermediate properties simultaneously.</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">checked</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">indeterminate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/cdk/testing/parallel">parallel</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> [</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    checkboxHarness.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isChecked</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    checkboxHarness.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isIndeterminate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  ]);</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(checked).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(indeterminate).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
  </div>