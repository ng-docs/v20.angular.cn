<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1">使用 effect 响应信号变化</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/tutorials/signals/steps/10-reacting-to-signal-changes-with-effect/README.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    <p>既然你已经学会了<a href="/tutorials/signals/9-query-child-elements-with-signal-queries">如何使用信号查询来查询子元素</a>，现在让我们来探索如何使用 effect 来响应信号变化。Effect 是当其依赖项发生变化时自动运行的函数，非常适合用于日志记录、DOM 操作或 API 调用等副作用。</p>
<p><strong>重要提示：Effect 应该是你最后考虑的 API。</strong>对于派生值，请始终优先使用 <code>computed()</code>；对于可以派生和手动设置的值，请优先使用 <code>linkedSignal()</code>。如果你发现自己使用 effect 将数据从一个信号复制到另一个信号，这表明你应该将你的事实之源（source-of-truth）移到更高层，并改用 <code>computed()</code> 或 <code>linkedSignal()</code>。Effect 最适合将信号状态同步到命令式、非信号 API。</p>
<p>在此活动中，你将学习如何为响应信号变化的合法副作用恰当地使用 <code>effect()</code> 函数。</p>
<hr>

<p>你有一个已经设置好信号的主题管理器应用。现在你将添加 effects 来自动响应信号变化。</p>

    <ol class="docs-steps">
      
    <li>
      <span class="docs-step-number" aria-hidden="true"></span>
      
  <h3 id="import-effect-function">
    <a href="#import-effect-function" class="docs-anchor" tabindex="-1" aria-label="Link to Import effect function">导入 effect 函数</a>
  </h3>
  
      <p>将 <code>effect</code> 添加到你现有的导入中。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Add effect to existing imports</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {Component, signal, computed, effect, ChangeDetectionStrategy} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre>
  </div><p><code>effect</code> 函数创建一个响应式的副作用，当它读取的任何信号发生变化时，该副作用会自动运行。</p>

    </li>
    
    <li>
      <span class="docs-step-number" aria-hidden="true"></span>
      
  <h3 id="create-an-effect-for-local-storage">
    <a href="#create-an-effect-for-local-storage" class="docs-anchor" tabindex="-1" aria-label="Link to Create an effect for local storage">为本地存储创建一个 effect</a>
  </h3>
  
      <p>添加一个 effect，当主题更改时自动将其保存到本地存储。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Save theme to localStorage whenever it changes</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  effect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'theme'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">theme</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Theme saved to localStorage:'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">theme</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  });</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>此 effect 在主题信号更改时运行，自动持久化用户的偏好设置。</p>

    </li>
    
    <li>
      <span class="docs-step-number" aria-hidden="true"></span>
      
  <h3 id="create-an-effect-for-logging-user-activity">
    <a href="#create-an-effect-for-logging-user-activity" class="docs-anchor" tabindex="-1" aria-label="Link to Create an effect for logging user activity">创建一个用于记录用户活动的 effect</a>
  </h3>
  
      <p>添加一个 effect，在用户登录或登出时进行记录。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // ... previous effect</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Log user activity changes</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  effect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isLoggedIn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'logged in'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'logged out'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`User ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">} is ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  });</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>此 effect 展示了 effects 如何读取多个信号并对其中任何信号的变化做出反应。</p>

    </li>
    
    <li>
      <span class="docs-step-number" aria-hidden="true"></span>
      
  <h3 id="create-an-effect-with-cleanup">
    <a href="#create-an-effect-with-cleanup" class="docs-anchor" tabindex="-1" aria-label="Link to Create an effect with cleanup">创建一个带清理功能的 effect</a>
  </h3>
  
      <p>添加一个 effect，该 effect 设置一个计时器并在组件销毁时进行清理。</p>
<div class="docs-code">
    
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // ... previous effects</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // Timer effect with cleanup</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  effect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">onCleanup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> interval</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Timer tick - Current theme:'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">theme</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"></span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Clean up the interval when the effect is destroyed</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    onCleanup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      clearInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(interval);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Timer cleaned up'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  });</span></span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>此 effect 展示了如何在 effect 被销毁或重新运行时清理资源。</p>

    </li>
    
    <li>
      <span class="docs-step-number" aria-hidden="true"></span>
      
  <h3 id="test-the-effects">
    <a href="#test-the-effects" class="docs-anchor" tabindex="-1" aria-label="Link to Test the effects">测试 effects</a>
  </h3>
  
      <p>打开浏览器控制台并与应用进行交互：</p>

  <ul class="docs-list">
    <li><strong>切换主题</strong> - 查看本地存储的保存和计时器日志</li>
<li><strong>登录/登出</strong> - 查看用户活动日志</li>
<li><strong>观察计时器</strong> - 查看每 5 秒一次的周期性主题日志</li>

  </ul>
  <p>当其跟踪的信号发生变化时，effects 会自动运行！</p>

    </li>
    
    </ol>
    <p>太棒了！你现在已经学会了如何将 effects 与信号一起使用。需要记住的关键概念：</p>

  <ul class="docs-list">
    <li><strong>Effects 是响应式的</strong>：当它们读取的任何信号发生变化时，它们会自动运行</li>
<li><strong>仅用于副作用</strong>：非常适合日志记录、DOM 操作、API 调用以及同步到命令式 API</li>
<li><strong>清理</strong>：使用 <code>onCleanup</code> 回调来清理计时器或订阅等资源</li>
<li><strong>自动跟踪</strong>：Effects 会自动跟踪它们读取的信号，并在这些信号发生变化时重新运行</li>

  </ul>
  <p><strong>请记住：谨慎使用 effects！</strong>本课中的示例（localStorage 同步、日志记录、计时器）是恰当的用法。避免将 effects 用于：</p>

  <ul class="docs-list">
    <li>从其他信号派生值 - 请改用 <code>computed()</code></li>
<li>创建可写派生状态 - 请改用 <code>linkedSignal()</code></li>
<li>在信号之间复制数据 - 请重构以使用共享的事实之源</li>

  </ul>
  <p>Effects 功能强大，但在 <code>computed()</code> 和 <code>linkedSignal()</code> 无法解决你的用例时，它们应该是你的最后选择。</p>
