<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1">解决 Zone 污染</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/best-practices/runtime-performance/zone-pollution.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    <p><strong>Zone.js</strong> 是一种信令机制，Angular 使用它来检测应用状态可能何时已更改。它会捕获异步操作，如 <code>setTimeout</code>、网络请求和事件监听器。Angular 基于来自 Zone.js 的信号来调度变更检测。</p>
<p>在某些情况下，调度的 <a href="https://developer.mozilla.org/docs/Web/API/HTML_DOM_API/Microtask_guide#tasks" target="_blank">任务</a> 或 <a href="https://developer.mozilla.org/docs/Web/API/HTML_DOM_API/Microtask_guide#microtasks" target="_blank">微任务</a> 不会对数据模型进行任何更改，这使得运行变更检测变得不必要。常见的例子有：</p>

  <ul class="docs-list">
    <li><code>requestAnimationFrame</code>、<code>setTimeout</code> 或 <code>setInterval</code></li>
<li>由第三方库进行的任务或微任务调度</li>

  </ul>
  <p>本节介绍如何识别此类情况，以及如何在 Angular Zone 之外运行代码以避免不必要的变更检测调用。</p>

  <h2 id="identifying-unnecessary-change-detection-calls">
    <a href="#identifying-unnecessary-change-detection-calls" class="docs-anchor" tabindex="-1" aria-label="Link to Identifying unnecessary change detection calls">识别不必要的变更检测调用</a>
  </h2>
  <p>你可以使用 Angular DevTools 检测不必要的变更检测调用。它们通常在性能分析器的时序图中显示为连续的条形，其来源为 <code>setTimeout</code>、<code>setInterval</code>、<code>requestAnimationFrame</code> 或事件处理程序。当你的应用中对这些 API 的调用有限时，变更检测调用通常是由第三方库引起的。</p>
<img alt="Angular DevTools profiler preview showing Zone pollution" src="assets/images/best-practices/runtime-performance/zone-pollution.png">

<p>在上图中，有一系列由与元素关联的事件处理程序触发的变更检测调用。这是使用第三方非原生 Angular 组件时的一个常见挑战，这些组件不会改变 <a href="/api/core/NgZone"><code>NgZone</code></a> 的默认行为。</p>

  <h2 id="run-tasks-outside-ngzone">
    <a href="#run-tasks-outside-ngzone" class="docs-anchor" tabindex="-1" aria-label="Link to Run tasks outside <code>NgZone</code>">在 <code>NgZone</code> 外部运行任务</a>
  </h2>
  <p>在这种情况下，你可以指示 Angular 避免为使用 <a href="/api/core/NgZone">NgZone</a> 的给定代码片段调度的任务调用变更检测。</p>
<div class="docs-code" header="Run outside of the Zone">
    <div class="docs-code-header"><h3>在 Zone 外部运行</h3></div>
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { <a href="/api/core/Component">Component</a>, NgZone, OnInit } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/Component">Component</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/core/OnInit">OnInit</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/core/NgZone">NgZone</a>);</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pollForUpdates), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>上面的代码片段指示 Angular 在 Angular Zone 之外调用 <code>setInterval</code>，并在 <code>pollForUpdates</code> 运行后跳过运行变更检测。</p>
<p>当第三方库的 API 在 Angular Zone 内被调用时，它们通常会触发不必要的变更检测周期。这种现象尤其会影响那些设置事件监听器或启动其他任务（如定时器、XHR 请求等）的库。通过在 Angular Zone 之外调用库 API 来避免这些额外的周期：</p>
<div class="docs-code" header="Move the plot initialization outside of the Zone">
    <div class="docs-code-header"><h3>将绘图初始化移到 Zone 外部</h3></div>
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { <a href="/api/core/Component">Component</a>, NgZone, OnInit } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'plotly.js-dist-min'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/Component">Component</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/core/OnInit">OnInit</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/core/NgZone">NgZone</a>);</span></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      Plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">newPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'chart'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, data);</span></span><span role="presentation" class="shiki-ln-number">11</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">12</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">13</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>在 <code>runOutsideAngular</code> 中运行 <code>Plotly.newPlot('chart', data);</code> 指示框架在执行由初始化逻辑调度的任务后不应运行变更检测。</p>
<p>例如，如果 <code>Plotly.newPlot('chart', data)</code> 向 DOM 元素添加事件监听器，则 Angular 在执行其处理程序后不会运行变更检测。</p>
<p>但有时，你可能需要监听由第三方 API 调度的事件。在这种情况下，重要的是要记住，如果初始化逻辑在那里完成，这些事件监听器也将在 Angular Zone 之外执行：</p>
<div class="docs-code" header="Check whether the handler is called outside of the Zone">
    <div class="docs-code-header"><h3>检查处理程序是否在 Zone 外部被调用</h3></div>
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { <a href="/api/core/Component">Component</a>, NgZone, OnInit, output } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'plotly.js-dist-min'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/Component">Component</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/core/OnInit">OnInit</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/core/NgZone">NgZone</a>);</span></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">  plotlyClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/core/output">output</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;();</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">11</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">12</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span role="presentation" class="shiki-ln-number">13</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">14</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">15</span><span class="line"></span><span role="presentation" class="shiki-ln-number">16</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">17</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> plotly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">newPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'chart'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, data);</span></span><span role="presentation" class="shiki-ln-number">18</span><span class="line"></span><span role="presentation" class="shiki-ln-number">19</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'plotly_click'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">20</span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // This handler will be called outside of the Angular zone because</span></span><span role="presentation" class="shiki-ln-number">21</span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // the initialization logic is also called outside of the zone. To check</span></span><span role="presentation" class="shiki-ln-number">22</span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // whether we're in the Angular zone, we can call the following:</span></span><span role="presentation" class="shiki-ln-number">23</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/core/NgZone">NgZone</a>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isInAngularZone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span><span role="presentation" class="shiki-ln-number">24</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.plotlyClick.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(event);</span></span><span role="presentation" class="shiki-ln-number">25</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">26</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">27</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>如果你需要向父组件调度事件并执行特定的视图更新逻辑，你应该考虑重新进入 Angular Zone 以指示框架运行变更检测或手动运行变更检测：</p>
<div class="docs-code" header="Re-enter the Angular zone when dispatching event">
    <div class="docs-code-header"><h3>当调度事件时，重新进入 Angular Zone</h3></div>
    <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { <a href="/api/core/Component">Component</a>, NgZone, OnInit, output } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'plotly.js-dist-min'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"><a href="/api/core/Component">Component</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/core/OnInit">OnInit</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(<a href="/api/core/NgZone">NgZone</a>);</span></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">  plotlyClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> <a href="/api/core/output">output</a></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;();</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">11</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">12</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span role="presentation" class="shiki-ln-number">13</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">14</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">15</span><span class="line"></span><span role="presentation" class="shiki-ln-number">16</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">17</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> plotly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">newPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'chart'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, data);</span></span><span role="presentation" class="shiki-ln-number">18</span><span class="line"></span><span role="presentation" class="shiki-ln-number">19</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'plotly_click'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">20</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">21</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.plotlyClick.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(event);</span></span><span role="presentation" class="shiki-ln-number">22</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      });</span></span><span role="presentation" class="shiki-ln-number">23</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">24</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">25</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
  </div><p>也可能出现将事件分派到 Angular 区域之外的情况。重要的是要记住，触发变更检测（例如，手动触发）可能会导致在 Angular 区域之外创建/更新视图。</p>
